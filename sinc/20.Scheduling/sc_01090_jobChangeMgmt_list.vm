############################################################
## 프로그램ID      : sc_01090_jobChangeMgmt_lst.vm
## 프로그램명      : Job Change 시간관리 조회
## 개발자          : 김현
## 개발일자        : 2009-02-18
##
## 관련 job file   : job_sinc_20_scheduling_00.xml
## 관련 query file : query_sinc_20_scheduling_00.xml
##
## REVISIONS
## VER        DATE        AUTHOR    DESCRIPTION
## ---------  ----------  --------  ------------------------------------
## 1.0        2009-02-18  김현      sc_01090_jobChangeMgmt_lst
##
############################################################


## 비정상적 접근 방지 
#loginCheck()
## 화면 resizing 을 위한 size 변수 
##set( $resizeFuncCallCode = "setGridAutoResize('117', '177')" )
#set( $resizeFuncCallCode = "setGridAutoResize('79', '152')" )

<script type='text/javascript' src='${project}/dwr/interface/commonUtil.js'></script>
<script type='text/javascript' src='${project}/dwr/interface/scheduling.js'></script>
<script type='text/javascript' src='${project}/dwr/engine.js'></script>
<script type='text/javascript' src='${project}/dwr/util.js'></script>

<script language=javascript for="WiseGrid" event="CellDblClick(strColumnKey, nRow)">  

    var colPlant_id   = WiseGrid.GetCellValue('PLANT',nRow) ;
    var colLine_id    = WiseGrid.GetCellValue('LINE_ID',nRow) ;
    var colProc_id    = WiseGrid.GetCellValue('PROC_ID',nRow) ;

    var colPlant_name = WiseGrid.GetCellValue('PLANT_NM',nRow) ;
    var colLine_name  = WiseGrid.GetCellValue('LINE_NM',nRow) ;
    var colProc_name  = WiseGrid.GetCellValue('PROC_NM',nRow) ;
 
    var paramString = "";
    paramString = "&plant_id="  + colPlant_id;
    paramString+= "&line_id="   + colLine_id;
    paramString+= "&proc_id="   + colProc_id;
    paramString+= "&plant_name="+ colPlant_name;
    paramString+= "&line_name=" + colLine_name;
    paramString+= "&proc_name=" + colProc_name;        
    
    var fileName = "sc_01090_jobChangeMgmt_list_pop";
    var service_url = "service.do?_moon_service="+fileName+"&_moon_perpage=200&_moon_pagenumber=1" + paramString;
    var newWin = window.showModalDialog(service_url, self, "dialogLeft:0px; dialogTop:0px; dialogWidth:800px; dialogHeight:480px ; dialogScrollbars=no");
    
    if(newWin == -1)
    {
        GoSearch('xx');
    }

</script>

## 등록/수정 화면 이동한 후, 본 화면으로 이동할 때 조회조건을 기억하기 위한 parameter
<input type="hidden" name="cd_grp_pre" value="$!{cd_grp}">
<input type="hidden" name="perpage_pre" value="${_moon_perpage}">
<input type="hidden" name="pagenumber_pre" value="$!{_moon_pagenumber}">

<table border="0" width="100%" height="100%" cellpading="0" cellspacing="0">
	## 기능 버튼 영역
	<tr>
		<td height="25" align="right">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="pd_top10 pd_bot10">
            	<tr>
                	<td align="right">
						#button("search")
						#toolbar_nscm($_moon_toolbar "" "" "" "")
					</td>
            	</tr>
        	</table>
		</td>
	</tr>	
	## 조회 영역
	<tr>
		<td width="100%" valign="top">
			<table border="0" width="100%" cellpading="0" cellspacing="0">
				<tr height="2"><td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td></tr>
				<tr>
					<td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
					<td width="100%">
            			<table id="search_menu" border="0" width="100%" cellpading="0" cellspacing="0" 
						style="background-color:#f2f2f2; display:block; ">
							<tr>
            					<td width="20%" align="right">
									공장 :
								</td>
								<td width="30%" align="left">
                        			<select name="plant_name" style="width:155px; " onChange="doChange(this);"> 
                        				<option value="">선택</option>
                    					#foreach( $condition in $plant_name_list )  
                    						<option value="$condition.get(0)" 
                    							#if($!{plant_name} == "${condition.get(0)}") selected #end>$condition.get(1)</option>											
                    					#end 
                        			</select>									
                        		</td>
            					<td width="10%" align="right">
									라인 :
								</td>
								<td width="40%" align="left">
                        			<a id="div_select_line">
                        				<select name="select_line" style="width:155px; "> 
                        					<option value="">
                        						전체
                        					</option> 
                        				</select>  
                        			</a>
                        		</td>
							</tr>
							<tr>
								<td width="20%" align="right">
									작업장 :
								</td> 
            					<td width="30%" align="left">
                        			<a id="div_select_proc">
                        				<select name="select_proc" style="width:155px; "> 
                        					<option value="">
                        						전체
                        					</option> 
                        				</select>  
                        			</a>
            					</td>								
            					<td width="10%" align="right">
								</td>							
								<td width="40%" align="left">
                        		</td>
							</tr>           				
            			</table>
					</td>
					<td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
				</tr>
				<tr height="2"><td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td></tr>
			</table>
		</td>
	</tr>	
	<input name="search_h" type="hidden" value="45"> ## search 조건 부분 높이 
	<tr><td height="5"></td></tr>
	## TAB 영역
	<tr>
		<td valign="top">
			<div class="tab-pane" id="tabPane1">
				## tab 좌측 여백
				#tabLeft()				
				<div class="tab-page" id="tabPage1" style="overflow:hidden; ">
					<h2 class="tab">${_moon_title}</h2>
					
					<table id="gridArea" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td>					

					<table name="grid" width="100%" border="0" cellpading="0" cellspacing="0" class="normal-table">
						<tr>
							<td align="left">
								<script>initWiseGrid("WiseGrid", "100%", "400");</script>
							</td>
						</tr>
					</table> 
					
					<table height="5"><tr><td></td></tr></table>
					<table align="center" border="0" cellpading="0" cellspacing="0" class="normal-table"><tr><td>
						<input type="hidden" name="_moon_service" value="${_moon_service}">
						<input type="hidden" name="_moon_pagenumber" value="$!{_moon_pagenumber}">
						<input type="hidden" name="_user_id" value="$!{_user_id}">
					</td></tr></table>
					
					</td></tr></table>
					
					## waiting 표시영역
					#waitingArea()
					
				</div>
			</div>
		</td>
	</tr>
</table>

<script>
	
	// 화면 resize
	$!{resizeFuncCallCode};
	function window.onresize() { $!{resizeFuncCallCode}; }
	
	// 도움말 내용 입력
	var helpStr = "◈ Job Change 시간조회 화면은 공장을 필수로 선택해서 조회합니다.";
	helpStr += "<br>◈ 조회된 리스트의 데이터를 더블클릭하면 해당되는 공장, 라인, 작업장의 FROM-TO그룹 수정화면으로 이동합니다.";	
	helpCont.innerHTML = helpStr;
	hDynamicHeight = 0; 
	
	//document.cookie = "webfxtab_tabPane1=1";	
	
	
		
   var GridObj = document.WiseGrid;
   var GridHeaderString = "";

/*┌──────────────────────────────────┐
  │WiseGrid 오브젝트가 생성되고 초기화된 후 발생하는 
  │JavaScript Event인 Initialize()를 받아 그리드의 헤더를 셋팅한다.
  └──────────────────────────────────┘*/
   function init() {
       setProperty(GridObj);//WiseGrid Default설정 부분 (WiseGrid_Property.js파일 내에 선언되어 있다.)
       setDefault();        //화면 기본 설정 
       setHeader(GridObj);  //해더생성 
       
       doQuery();
   }
   
/*┌──────────────────────────────────┐
  │화면 기본 설정 부분.
  └──────────────────────────────────┘*/
   function setDefault()
   {


   }


   	
   	
/*┌──────────────────────────────────┐
  │해더생성
  └──────────────────────────────────┘*/
   function setHeader(GridObj) 
   {		
       GridObj.AddHeader("CRUD"          ,"구분"       ,"t_text" ,10  ,55  ,false);      
       GridObj.AddHeader("PLANT"         ,"Code"       ,"t_text" ,20  ,40  ,false); //0   
       GridObj.AddHeader("PLANT_NM"      ,"Name"       ,"t_text" ,20  ,80  ,false); //1   
       GridObj.AddHeader("LINE_ID"       ,"Code"       ,"t_text" ,18  ,40  ,false); //2   
       GridObj.AddHeader("LINE_NM"       ,"Name"       ,"t_text" ,200 ,160 ,false); //3   
       GridObj.AddHeader("PROC_ID"       ,"Code"       ,"t_text" ,18  ,45  ,false); //4   
       GridObj.AddHeader("PROC_NM"       ,"Name"       ,"t_text" ,200 ,160 ,false); //5   
       GridObj.AddHeader("FROM_GROUP"    ,"Code"       ,"t_text" ,18  ,45  ,false); //6   
       GridObj.AddHeader("FROM_GROUP_NM" ,"Name"       ,"t_text" ,200 ,160 ,false); //7   
       GridObj.AddHeader("TO_GROUP"      ,"ID"         ,"t_text" ,18  ,45  ,false); //8   
       GridObj.AddHeader("TO_GROUP_NM"   ,"Name"       ,"t_text" ,200 ,160 ,false); //9   
       GridObj.AddHeader("JC_TIME"       ,"J/C Time"   ,"t_text" ,10  ,60  ,true ); //10 
       GridObj.AddHeader("BOX_QTY"       ,"BOX"        ,"t_text" ,10  ,60  ,true ); //11 
       
       //해더 그룹생성
       GridObj.AddGroup("PLANTGROUP","공장");
       GridObj.AppendHeader("PLANTGROUP","PLANT");
       GridObj.AppendHeader("PLANTGROUP","PLANT_NM");

       GridObj.AddGroup("LINEGROUP","라인");
       GridObj.AppendHeader("LINEGROUP","LINE_ID");
       GridObj.AppendHeader("LINEGROUP","LINE_NM");

       GridObj.AddGroup("PROCGROUP","작업장");
       GridObj.AppendHeader("PROCGROUP","PROC_ID");
       GridObj.AppendHeader("PROCGROUP","PROC_NM");

       GridObj.AddGroup("FROMGROUP","From 그룹");
       GridObj.AppendHeader("FROMGROUP","FROM_GROUP");
       GridObj.AppendHeader("FROMGROUP","FROM_GROUP_NM");
       
       GridObj.AddGroup("TOGROUP","To 그룹");
       GridObj.AppendHeader("TOGROUP","TO_GROUP");
       GridObj.AppendHeader("TOGROUP","TO_GROUP_NM");

   	   GridObj.BoundHeader();	
   	   
   	   //해더 Hidden
   	   GridObj.SetColHide("CRUD", true);
   	   
   	   GridObj.SetCRUDMode("CRUD", "추가", "수정", "삭제"); //수정,삭제,추가 구분 부분.
   }
   	

/*┌──────────────────────────────────┐
  │화면에 '조회'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
   function GoSearch(service) 
   {
       doQuery();
   }
  
  
  
  
/*┌──────────────────────────────────┐
  │화면에 '저장'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
   function GoSave  (service)
   {
	    var servlet_url = Project_name+"/servlet/com.wisegrid.admin.sc_01090_jobChangeMgmt_lst";
    
    	//WiseGrid가 서버에 전송할 mode를 셋팅한다.
    	GridObj.SetParam("mode", "save");
    	GridObj.SetParam("_user_id",document.all._user_id.value);
    
    	//WiseGrid가 서버와 통신시에 데이터를 전달한
    	GridObj.DoQuery(servlet_url, "CRUD");
    	
   }
      
   
/*┌──────────────────────────────────┐
  │조회 쿼리를 호출 Fnc
  └──────────────────────────────────┘*/
   function doQuery() 
   {
       var plant_name = document.all.plant_name.value ;   
       var line       = document.all.select_line.value;    
       var proc       = document.all.select_proc.value;
       
       var servlet_url = Project_name+"/servlet/com.wisegrid.admin.sc_01090_jobChangeMgmt_lst";

       //넘겨줄 값들을만든다.( 파라미터 정의 부분 )
       GridObj.SetParam("mode", "search");
       GridObj.SetParam("plant_name", plant_name);
       GridObj.SetParam("line", line);
       GridObj.SetParam("proc", proc);
       GridObj.DoQuery(servlet_url);
       
       GridObj.ClearGrid() 
       setHeader(GridObj);  //해더생성 
   }


/*┌──────────────────────────────────┐
  │데이터 조회가 정상적으로 완료되면 발생되는 Event에 대한 Fnc
  └──────────────────────────────────┘*/
    function GridEndQuery() 
    {
        var mode = GridObj.GetParam("mode");
        var error_msg = '';
        if(mode == "search") //조회가 완료된 경우
        {
            if(GridObj.GetStatus() == "true") 
            {                                                    
                //데이터를 그룹핑 한다.                                                     
                GridObj.SetGroupMerge("PLANT,PLANT_NM,LINE_ID,LINE_NM,PROC_ID,PROC_NM,FROM_GROUP,FROM_GROUP_NM");                                                    
                GridObj.SetColCellAlign('JC_TIME','right') 
                GridObj.SetColCellAlign('BOX_QTY','right') 
            } else	
            { 
                error_msg = GridObj.GetMessage(); 
                alert(error_msg);			
            }
        } else if(mode=='save') { //저장이 완료된 경우 
            if(GridObj.GetStatus() == "true") 
        	{
        	    doQuery() ;
            } else	{
                error_msg = GridObj.GetMessage();
                alert(error_msg);			
            }
        }
    }
    
    
   
/*┌──────────────────────────────────┐
  │그리드의 데이터가 변경 되었을 경우 처리되는 Fnc
  └──────────────────────────────────┘*/
   function GridChangeCell(strColumnKey, nRow) 
   {
   	/*
   	if(strColumnKey != "SELECTED") {
   		//??? ? SELECTED ?? ??? ??? ?? ???. 
   		GridObj.SetCellValue("SELECTED", nRow, "1");
   	}
   	*/
   }    
    
    
    

 
   
   /* ?? */
   function doInsert() {
   	var GridObj = document.WiseGrid;
   	var servlet_url = Project_name+"/servlet/com.wisegrid.admin.user_list";
   
   	if(!chkSelected()) {
   		alert("??? ?? ????.");
   		return;	
   	}
   
   	//WiseGrid? ??? ??? mode? ????.
   	GridObj.SetParam("mode", "insert");
   
   	//WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
   	GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ?? */
   function doUpdata() {
   	var GridObj = document.WiseGrid;
   	var servlet_url = Project_name+"/servlet/com.wisegrid.sample.basic_example_select";
   
   	if(!chkSelected()) {
   		alert("??? ?? ????.");
   		return;	
   	}
   
   	//WiseGrid? ??? ??? mode? ????.
   	GridObj.SetParam("mode", "update");
   
   	//WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
   	GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ?? */
   function doDelete() {
   	var GridObj = document.WiseGrid;
   	var servlet_url = Project_name+"/servlet/wisegrid.sample.basic_example_select";
   
   	if(!chkSelected()) {
   		alert("??? ?? ????.");
   		return;	
   	}
   
   	//WiseGrid? ??? ??? mode? ????.
   	GridObj.SetParam("mode", "delete");
   
   	//WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
   	GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ??? ?????? ????. */
   function chkSelected() {
   	var GridObj = document.WiseGrid;
   	chkCount = 0;
   
   	for(i = 0; i < GridObj.GetRowCount(); i++) { //??? ???? ???? ????. 
   
   		if(GridObj.GetCellValue("SELECTED", i) == "1") //??? ?? ?? ????. 
   			chkCount = chkCount + 1;
   	}
   	
   	if(chkCount == 0) {
   		return false;	
   	}
   	return true;
   }
   
   /* ? ?? */
   function doLineInsert() {
   	var GridObj = document.WiseGrid;
   	
   	//???? ??? ?? ? ??? ????. 
   	GridObj.AddRow();
   	
   	//??? ? SELECTED? Active? ??? ???? ?? ???.
   	GridObj.SetCellValue("SELECTED",GridObj.GetActiveRowIndex(), "1");
   
   	//ITEM_CODE ?? ??? ????? Active? ??? ???? ???? ????. 
   	GridObj.SetCellImage('ITEM_CODE', GridObj.GetActiveRowIndex(), 0);
   
   	//??? ?? ? ITEM_CODE? Active? ??? ???? ??? ???? ??.
   	GridObj.SetCellActivation("ITEM_CODE", GridObj.GetActiveRowIndex(), "edit");
   }
   
   /* EXCEL ???? */
   function excelDown() {
   	var GridObj = document.WiseGrid;
   	//???? ???? ???? PC? ??? ????. SetColHide()? ??? ??? ???? ???. 
   	GridObj.ExcelExport("", "", true, true);
   }

   

   
   function getdatetime() {
   	var today = new Date();
   	var year = today.getYear();
   	var month = today.getMonth() + 1;
   	var day = today.getDate();
   	
   	if(month < 10)
   		month = "0" + month;
   		
   	if(day < 10)
   		day = "0" + day;
   
   	document.frm.to_date.value = year + "" + month + "" + day;
   }
   
  
/*┌──────────────────────────────────┐
  │그리드의 원 클릭 이벤트
  └──────────────────────────────────┘*/
   function GridCellClick(strColumnKey, nRow){
   }		
   		


/*┌──────────────────────────────────┐
  │그리드의 사이즈 조절 Fnc
  └──────────────────────────────────┘*/
    function setGridAutoResize( tab_h, table_h ){
    	
    	var maxWidthValue;
    	var maxHeightValue;
    	
    	if (document.layers) {
    		//Nescape
    		maxWidthValue = window.innerWidth;
    		maxHeightValue = window.innerHeight;
    	}
    	if (document.all) {
    		//explore
    		maxWidthValue = document.body.clientWidth;
    		maxHeightValue = document.body.clientHeight;
    	} 
    	
    	var tabHeightValue = Number(maxHeightValue) - Number(tab_h) ; 
    	var tableHeightValue = Number(maxHeightValue) - Number(table_h) ; 
    	
    	var search_h = document.frm.search_h.value; 
    	if( search_menu.style.display == "none" ) 
    	{ 
    		tabHeightValue += Number(search_h); 
    		tableHeightValue += Number(search_h); 
    	} 
    	
    	// 화면 size 축소 시 화면이 너무 작아 그리드 크기가 음수가 되면 에러가 나므로 그 경우 무조건 1로 세팅 
    	// ==> 화면이 더이상 축소되지 않음 
    	if( tabHeightValue < 1 ) 
    		tabHeightValue = 1; 
    	if( tableHeightValue < 1 ) 
    		tableHeightValue = 1; 
    	
    	tabPage1.style.height = tabHeightValue + "px"; 
    	//tbMain.style.height = tableHeightValue + "px"; 
    	document.WiseGrid.height = tableHeightValue + "px"; 
    	
    } 	


	//combo box 변화하는(라인,작업장 박스) 함수
	function doChange(obj){	
		doChangePlant(obj);	
		doChangeLine(obj);
	}
	
	
	// combo box:공장 선택시 라인  리스트 채움
	function doChangePlant(obj){ 
		var div_won = "<select name=\"select_line\" onChange=\"doChangeLine(this); \" style=\"width:155px; \" >";
		div_won += "<option value=\"\">전체</option>";		
			#foreach( $condition in $line_name_list )
				if( obj.value == "$condition.get(0)"){
					div_won += "<option value=\"$condition.get(1)\" ";
						if("$condition.get(1)" == "$!{select_line}")
							div_won += " selected ";
					div_won += ">$condition.get(2)</option>";
				}
			#end

		div_won += "</select>";
		div_select_line.innerHTML = div_won;					
	}
	doChangePlant(document.frm.plant_name);
	
		
	// combo box:공장선택하고 그후 라인선택시 작업장 리스트 채움
	function doChangeLine(obj){
	
		var plant_id = document.frm.plant_name.value;
		var div_pro = "<select name=\"select_proc\" style=\"width:155px; \" >";
		div_pro += "<option value=\"\">전체</option>";	
			#foreach( $condition in $proc_name_list )
				if ( plant_id == "$condition.get(0)" ) {
    				if( obj.value == "$condition.get(1)"){
    					div_pro += "<option value=\"$condition.get(2)\" ";
    						if("$condition.get(2)" == "$!{select_proc}")
    							div_pro += " selected ";
    					div_pro += ">$condition.get(3)</option>";
    				}
				}
			#end			
		
		div_pro += "</select>";
		div_select_proc.innerHTML = div_pro;		
		
	}
	doChangeLine(document.frm.select_line);	
   		
</script> 
