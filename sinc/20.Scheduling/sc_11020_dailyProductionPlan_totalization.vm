############################################################
## 프로그램ID      : sc_11020_dailyProductionPlan_totalization.vm
## 프로그램명      : 일단위 생산계획 변경요인 집ㄱ_
## 개발자          : 김현
## 개발일자        : 2009-03-10
##
## 관련 job file   : job_sc_11020_dailyProductionPlan_totalization.xml
## 관련 query file : query_sc_11020_dailyProductionPlan_totalization.xml
##
## REVISIONS
## VER        DATE        AUTHOR    DESCRIPTION
## ---------  ----------  --------  ------------------------------------
## 1.0        2009-03-10  김현      create
##
############################################################


## 비정상적 접근 방지 
#loginCheck()
## 화면 resizing 을 위한 size 변수 
##set( $resizeFuncCallCode = "setGridAutoResize('117', '125')" )
#set( $resizeFuncCallCode = "setGridAutoResize('79', '100')" )

<script type='text/javascript' src='${project}/dwr/interface/commonUtil.js'></script>
<script type='text/javascript' src='${project}/dwr/interface/scheduling.js'></script>
<script type='text/javascript' src='${project}/dwr/engine.js'></script>
<script type='text/javascript' src='${project}/dwr/util.js'></script>

## 등록/수정 화면 이동한 후, 본 화면으로 이동할 때 조회조건을 기억하기 위한 parameter
<input type="hidden" name="cd_grp_pre" value="$!{cd_grp}">
<input type="hidden" name="perpage_pre" value="${_moon_perpage}">
<input type="hidden" name="pagenumber_pre" value="$!{_moon_pagenumber}">


<script language="javascript" for="WiseGrid2" event="Initialize()">
	init2();
</script>

<!--  	서버와의 통신이 정상적으로 완료되면 발생한다.   -->
<script language="javascript" for="WiseGrid2" event="EndQuery()">
	GridEndQuery2();
</script>

<table border="0" width="100%" height="100%" cellpading="0" cellspacing="0">
    ## 기능 버튼 영역
    <tr>
        <td height="25" align="right">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="pd_top10 pd_bot10">
                <tr>
                    <td align="right">
                        #button("search")
                        #toolbar_nscm($_moon_toolbar "" "" "" "")
                    </td>
                </tr>
            </table>
        </td>
    </tr>    
    ## 조회 영역
    <tr>
        <td width="100%" valign="top">
            <table border="0" width="100%" cellpading="0" cellspacing="0">
                <tr height="2">
                    <td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                </tr>
                <tr>
                    <td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                    <td width="100%">
                        <table border="0" width="100%" cellpading="0" cellspacing="0" id="search_menu" style="background-color:#f2f2f2; display:block; ">
                            <tr >            
								
								<td width="70" align="right">보정 구간 :</td> 
								<td width="220">  																	    
            						#date_sole_no_title( "start_date" "10" "normal" "dutyBtn" $date.get('yyyy-MM-dd'))
            						~
            						#date_sole_no_title( "end_date" "10" "normal" "dutyBtn2" $date.get('yyyy-MM-dd'))
            					</td>
            					<td width="70" align="right">공장 :</td> 
            					<td align="left">    
									<select name="selected_plant" style="width:100px;")> 
										<option value="">전체</option>
									#foreach( $condition in $combo_plant_list )  
										<option value="$condition.get(0)" #if($!{selected_plant} == "$condition.get(0)") selected #else #end >$condition.get(1)</option>											
									#end 
   									</select> 
            					</td> 
            					
                            </tr>
                        </table> 
                    </td>
                    <td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                </tr>
                <tr height="2"><td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td></tr>
            </table>
        </td> 
    </tr>

    <input name="search_h" type="hidden" value="45"> ## search 조건 부분 높이 
    <tr><td height="1"></td></tr>
    ## TAB 영역
    <tr>
        <td valign="top">
        ## tab 좌측 여백
        #tabLeft()                
            
            <table id="gridArea" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td>                    

            <table name="grid" width="100%" border="0" cellpading="0" cellspacing="0" class="normal-table">
                <tr>
                    <td align="left" width=265>
                        <script>initWiseGrid("WiseGrid", "262", "400");</script>
                    </td>
                    <td align="rifht">
                        <script>initWiseGrid("WiseGrid2", "100%", "400");</script>
                    </td>
                </tr>
            </table> 
            
            <table height="5"><tr><td></td></tr></table>
            <table align="center" border="0" cellpading="0" cellspacing="0" class="normal-table"><tr><td>
                <input type="hidden" name="_moon_service" value="${_moon_service}">
                <input type="hidden" name="_moon_pagenumber" value="$!{_moon_pagenumber}">
                <input type="hidden" name="_user_id" value="$!{_user_id}">
            </td></tr></table>
            
            </td></tr></table>
            
            ## waiting 표시영역
            #waitingArea()
                    
        </td>
    </tr>
</table>

<script>
    
    var job_id = 'sc_11020_dailyProductionPlan_totalization01';
    var job_id2= 'sc_11020_dailyProductionPlan_totalization02';
    
    // 화면 resize
    $!{resizeFuncCallCode};
    function window.onresize() { $!{resizeFuncCallCode}; }
    
    // 도움말 내용 입력
    var helpStr = "◈ Job Change 시간 ";    
    helpCont.innerHTML = helpStr;
    hDynamicHeight = 0; 
    
    //document.cookie = "webfxtab_tabPane1=1";    
    
    
        
   var GridObj = document.WiseGrid;
   var GridObj2= document.WiseGrid2;
   var GridHeaderString = "";

/*┌──────────────────────────────────┐
  │WiseGrid 오브젝트가 생성되고 초기화된 후 발생하는 
  │JavaScript Event인 Initialize()를 받아 그리드의 헤더를 셋팅한다.
  └──────────────────────────────────┘*/
   function init() { 
   
       setProperty(GridObj);//WiseGrid Default설정 부분 (WiseGrid_Property.js파일 내에 선언되어 있다.)
	   //setDefault();        //화면 기본 설정 
       setHeader(GridObj);  //해더생성 
   }
   
   function init2() {
   		
       setProperty(GridObj2);//WiseGrid Default설정 부분 (WiseGrid_Property.js파일 내에 선언되어 있다.)
	   
	   setDefault();        //화면 기본 설정 
       setHeader2(GridObj2);  //해더생성 
   }   
   
/*┌──────────────────────────────────┐
  │화면 기본 설정 부분.
  └──────────────────────────────────┘*/
   function setDefault()
   { 
		
   }


       
       
/*┌──────────────────────────────────┐
  │해더생성
  └──────────────────────────────────┘*/
   function setHeader(GridObj) 
   {        
       commonUtil.getCodeList("job_id", job_id , "gird_header_list",defaultHeader); 
       //commonUtil.getCodeList("job_id", job_id2 , "gird_header_list",defaultHeader2); 
       
   }
   
   function setHeader2(GridObj) 
   {        
       //commonUtil.getCodeList("job_id", job_id , "gird_header_list",defaultHeader); 
       commonUtil.getCodeList("job_id", job_id2 , "gird_header_list",defaultHeader2); 
       
   }
   

/*┌──────────────────────────────────┐
  │DB에 등록된 화면 해더 정보를 가져온다.
  └──────────────────────────────────┘*/
   function defaultHeader(result)
   {
       var test = '';
       var arrHeader = '';
       for( var i=0 ;i<result.length ;i++) //전체 Row만큼 반복 한다.
       {
           arrHeader = result[i].split('!%!');
           GridObj.AddHeader(arrHeader[1]  ,arrHeader[2]  ,arrHeader[3]  ,arrHeader[4]  ,arrHeader[5]  ,arrHeader[6]);        
       }
       //해더 그룹생성
       GridObj.AddGroup("GR_REASON","보정");  //날짜 그룹
       GridObj.AppendHeader("GR_REASON","R01_NAME");
       GridObj.AppendHeader("GR_REASON","R02_NAME");
       GridObj.AppendHeader("GR_REASON","R02_COUNT");
       GridObj.AppendHeader("GR_REASON","R02_PERCENT");
	   GridObj.BoundHeader();

       //Hidden 컬럼 
       GridObj.SetColHide("REASON01",true);
       GridObj.SetColHide("REASON02",true);
       //doQuery();
              
   }
               
/*┌──────────────────────────────────┐
  │DB에 등록된 화면 해더 정보를 가져온다.
  └──────────────────────────────────┘*/
   function defaultHeader2(result)
   {
       var test = '';
       var arrHeader = '';
       for( var i=0 ;i<result.length ;i++) //전체 Row만큼 반복 한다.
       {
           arrHeader = result[i].split('!%!');
           GridObj2.AddHeader(arrHeader[1]  ,arrHeader[2]  ,arrHeader[3]  ,arrHeader[4]  ,arrHeader[5]  ,arrHeader[6]);        
       }
       //해더 그룹생성
      GridObj2.AddGroup("GR_QTY","수량");  //전/후 그룹
      GridObj2.AppendHeader("GR_QTY","FROM_SHIFT_QTY");
      GridObj2.AppendHeader("GR_QTY","TO_SHIFT_QTY");
	  
	  GridObj2.AddGroup("GR_REASON2","보정");  //구분/일자/수정자 그룹
      GridObj2.AppendHeader("GR_REASON2","MADE_TYPE");
      GridObj2.AppendHeader("GR_REASON2","MADE_DTTM");
	  GridObj2.AppendHeader("GR_REASON2","MADE_BY");
	  
      GridObj2.BoundHeader();

       //Hidden 컬럼 
       GridObj2.SetColHide("R01_NAME",true);
       GridObj2.SetColHide("R02_NAME",true); 
              
              
       //setProperty(GridObj2);//WiseGrid Default설정 부분 (WiseGrid_Property.js파일 내에 선언되어 있다.)
              
   }
     
  
               
/*┌──────────────────────────────────┐
  │화면에 '조회'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
   function GoSearch(service) 
   {
       doQuery();
   }
  
  
  
  
/*┌──────────────────────────────────┐
  │화면에 '저장'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
   function GoSave  (service)
   {
   }
      
   
/*┌──────────────────────────────────┐
  │첫번째 그리드의 조회 쿼리를 호출 Fnc
  └──────────────────────────────────┘*/
   function doQuery() 
   {
       var servlet_url = Project_name+"/servlet/com.wisegrid.admin."+job_id;

       var startDate = document.all.start_date.value;
       var endDate   = document.all.end_date.value;
       var plant_id  = document.all.selected_plant.value;
       
       //넘겨줄 값들을만든다.( 파라미터 정의 부분 )
       GridObj.SetParam("mode", "search");
       GridObj.SetParam("startDate", startDate);
       GridObj.SetParam("endDate", endDate);
       GridObj.SetParam("plant_id", plant_id);
       GridObj.DoQuery(servlet_url);
   }

/*┌──────────────────────────────────┐
  │두번째 그리드의 조회 쿼리를 호출 Fnc
  └──────────────────────────────────┘*/
   function doQuery2(reason02) 
   {
       var servlet_url = Project_name+"/servlet/com.wisegrid.admin."+job_id2;

       var startDate = document.all.start_date.value;
       var endDate   = document.all.end_date.value;
       var plant_id  = document.all.selected_plant.value;
              
       //넘겨줄 값들을만든다.( 파라미터 정의 부분 )
       GridObj2.SetParam("mode", "search");
       GridObj2.SetParam("startDate", startDate);
       GridObj2.SetParam("endDate", endDate);
       GridObj2.SetParam("plant_id", plant_id);
       GridObj2.SetParam("reason02", reason02);
       GridObj2.DoQuery(servlet_url);
   }
   

/*┌──────────────────────────────────┐
  │데이터 조회가 정상적으로 완료되면 발생되는 Event에 대한 Fnc
  └──────────────────────────────────┘*/
    function GridEndQuery() 
    {
        var mode = GridObj.GetParam("mode");
        var error_msg = '';
          
        var arrA = '';
        var arrB = '';
        var arrC = '';
        
        if(mode == "search") //조회가 완료된 경우
        {
            if(GridObj.GetStatus() == "true") 
            {                           
                GridObj.SetColCellAlign("R02_COUNT",'right');      
                GridObj.SetColCellAlign("R02_PERCENT",'right');      
                                     
                //데이터를 그룹핑 한다.                                                     
                GridObj.SetGroupMerge("R01_NAME,R02_NAME");                                                    
            } else    
            { 
                error_msg = GridObj.GetMessage(); 
                alert(error_msg);            
            }
        }
    }
    

/*┌──────────────────────────────────┐
  │데이터 조회가 정상적으로 완료되면 발생되는 Event에 대한 Fnc
  └──────────────────────────────────┘*/
    function GridEndQuery2() 
    {
        var mode = GridObj2.GetParam("mode");
        var error_msg = '';
          
        if(mode == "search") //조회가 완료된 경우
        {
            if(GridObj.GetStatus() == "true") 
            {                           
                GridObj2.SetColCellAlign("FROM_SHIFT_QTY",'right');
                GridObj2.SetColCellAlign("TO_SHIFT_QTY",'right');
				GridObj2.SetColCellAlign("TIME_FENCE",'center');
            } else    
            { 
                error_msg = GridObj.GetMessage(); 
                alert(error_msg);            
            }
        }
		
		// 컬럼 그룹
		GridObj2.SetGroupMerge('R01_NAME,R02_NAME,PLANT_NAME,PROC_NAME,ITEM_NAME'); 
    }
    
   
/*┌──────────────────────────────────┐
  │그리드의 데이터가 변경 되었을 경우 처리되는 Fnc
  └──────────────────────────────────┘*/
   function GridChangeCell(strColumnKey, nRow) 
   {
       /*
       if(strColumnKey != "SELECTED") {
           //??? ? SELECTED ?? ??? ??? ?? ???. 
           GridObj.SetCellValue("SELECTED", nRow, "1");
       }
       */
   }    
    
    
    

 
   
   /* ?? */
   function doInsert() {
       var GridObj = document.WiseGrid;
       var servlet_url = Project_name+"/servlet/com.wisegrid.admin.user_list";
   
       if(!chkSelected()) {
           alert("??? ?? ????.");
           return;    
       }
   
       //WiseGrid? ??? ??? mode? ????.
       GridObj.SetParam("mode", "insert");
   
       //WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
       GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ?? */
   function doUpdata() {
       var GridObj = document.WiseGrid;
       var servlet_url = Project_name+"/servlet/com.wisegrid.sample.basic_example_select";
   
       if(!chkSelected()) {
           alert("??? ?? ????.");
           return;    
       }
   
       //WiseGrid? ??? ??? mode? ????.
       GridObj.SetParam("mode", "update");
   
       //WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
       GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ?? */
   function doDelete() {
       var GridObj = document.WiseGrid;
       var servlet_url = Project_name+"/servlet/wisegrid.sample.basic_example_select";
   
       if(!chkSelected()) {
           alert("??? ?? ????.");
           return;    
       }
   
       //WiseGrid? ??? ??? mode? ????.
       GridObj.SetParam("mode", "delete");
   
       //WiseGrid? ??? ???? ???? ????. ????? ??? ??? ???? ??.
       GridObj.DoQuery(servlet_url, "SELECTED");
   }
   
   /* ??? ?????? ????. */
   function chkSelected() {
       var GridObj = document.WiseGrid;
       chkCount = 0;
   
       for(i = 0; i < GridObj.GetRowCount(); i++) { //??? ???? ???? ????. 
   
           if(GridObj.GetCellValue("SELECTED", i) == "1") //??? ?? ?? ????. 
               chkCount = chkCount + 1;
       }
       
       if(chkCount == 0) {
           return false;    
       }
       return true;
   }
   
   /* ? ?? */
   function doLineInsert() {
       var GridObj = document.WiseGrid;
       
       //???? ??? ?? ? ??? ????. 
       GridObj.AddRow();
       
       //??? ? SELECTED? Active? ??? ???? ?? ???.
       GridObj.SetCellValue("SELECTED",GridObj.GetActiveRowIndex(), "1");
   
       //ITEM_CODE ?? ??? ????? Active? ??? ???? ???? ????. 
       GridObj.SetCellImage('ITEM_CODE', GridObj.GetActiveRowIndex(), 0);
   
       //??? ?? ? ITEM_CODE? Active? ??? ???? ??? ???? ??.
       GridObj.SetCellActivation("ITEM_CODE", GridObj.GetActiveRowIndex(), "edit");
   }
   
   /* EXCEL ???? */
   function excelDown() {
       var GridObj = document.WiseGrid;
       //???? ???? ???? PC? ??? ????. SetColHide()? ??? ??? ???? ???. 
       GridObj.ExcelExport("", "", true, true);
   }

   

   
   function getdatetime() {
       var today = new Date();
       var year = today.getYear();
       var month = today.getMonth() + 1;
       var day = today.getDate();
       
       if(month < 10)
           month = "0" + month;
           
       if(day < 10)
           day = "0" + day;
   
       document.frm.to_date.value = year + "" + month + "" + day;
   }
   
  
/*┌──────────────────────────────────┐
  │그리드의 원 클릭 이벤트
  └──────────────────────────────────┘*/
   function GridCellClick(strColumnKey, nRow){     
      if(strColumnKey=='R02_COUNT')
      {
          //GridObj.GetCellValue('CD0'+strColumnKey.substr(2,2),nRow).split('_MSG_');
          doQuery2(GridObj.GetCellValue("REASON02" ,nRow));
		  
		  if( GridObj.GetCellValue("R01_NAME", nRow) == "전체" ){ // 내역, 상세 컬럼 숨김 해제(우측 그리드)
		      GridObj2.SetColHide("R01_NAME",false);
              GridObj2.SetColHide("R02_NAME",false);
			  GridObj2.SetGroupMerge('R01_NAME,R02_NAME,PLANT_NAME,PROC_NAME,ITEM_NAME'); 
		  }else{											     // 내역, 상세 컬럼 숨김(우측 그리드)
		  	  GridObj2.SetColHide("R01_NAME",true);
              GridObj2.SetColHide("R02_NAME",true);
			  GridObj2.SetGroupMerge('PLANT_NAME,PROC_NAME,ITEM_NAME'); 
		  }
      }
   }        
           


/*┌──────────────────────────────────┐
  │그리드의 사이즈 조절 Fnc
  └──────────────────────────────────┘*/
    function setGridAutoResize( tab_h, table_h ){
        
        var maxWidthValue;
        var maxHeightValue;
        
        if (document.layers) {
            //Nescape
            maxWidthValue = window.innerWidth;
            maxHeightValue = window.innerHeight;
        }
        if (document.all) {
            //explore
            maxWidthValue = document.body.clientWidth;
            maxHeightValue = document.body.clientHeight;
        } 
        
        var tabHeightValue = Number(maxHeightValue) - Number(tab_h) ; 
        var tableHeightValue = Number(maxHeightValue) - Number(table_h) ; 
        
        var search_h = document.frm.search_h.value; 
        if( search_menu.style.display == "none" ) 
        { 
            tabHeightValue += Number(search_h); 
            tableHeightValue += Number(search_h); 
        } 
        
        // 화면 size 축소 시 화면이 너무 작아 그리드 크기가 음수가 되면 에러가 나므로 그 경우 무조건 1로 세팅 
        // ==> 화면이 더이상 축소되지 않음 
        if( tabHeightValue < 1 ) 
            tabHeightValue = 1; 
        if( tableHeightValue < 1 ) 
            tableHeightValue = 1; 
        
        //tabPage1.style.height = tabHeightValue + "px"; 
        //tbMain.style.height = tableHeightValue + "px"; 
        document.WiseGrid.height = tableHeightValue + "px"; 
        document.WiseGrid2.height = tableHeightValue + "px"; 
        
    }  
           
</script> 
