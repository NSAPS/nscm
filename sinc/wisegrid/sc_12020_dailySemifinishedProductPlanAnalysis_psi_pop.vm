############################################################
## 프로그램ID      : sc_12020_dailySemifinishedProductPlanAnalysis_psi_pop
## 프로그램명      : 반제품 생산계획 조정(스프) 계획 추가 팝업
## 개발자          : 김현
## 개발일자        : 
##
## REVISIONS
## VER        DATE        AUTHOR    DESCRIPTION
## ---------  ----------  --------  ------------------------------------
## 1.0        2009-04-09  KH        Create 
##
############################################################


## 비정상적 접근 방지 
#loginCheck()
## 화면 resizing 을 위한 size 변수 
##set( $resizeFuncCallCode = "setGridAutoResize('117', '125')" )
#set( $resizeFuncCallCode = "setWiseGridAutoResize('40', '52')" ) 

<script type='text/javascript' src='${project}/dwr/interface/commonUtil.js'></script>
<script type='text/javascript' src='${project}/dwr/interface/scheduling.js'></script>
<script type='text/javascript' src='${project}/dwr/engine.js'></script>
<script type='text/javascript' src='${project}/dwr/util.js'></script>



<table border="0" width="100%" height="100%" cellpading="0" cellspacing="0">
	## 기능 버튼 영역
	
	<script> 
		//areaBtn.innerHTML = " &nbsp; <input type=\"button\" name=\"btnExecIF\" id=\"btnExecIF\" value=\" 조회\" onClick=\"GoSearch('sc_12020_dailySemifinishedProductPlanAnalysisNewStockChk_popup'); \" class=\"btn1_on\">";
	</script>   
	
    ## 조회 영역
    <tr>
        <td width="100%" valign="top">
            <table border="0" width="100%" cellpading="0" cellspacing="0">
                <tr height="2">
                    <td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                </tr>
                <tr>
                    <td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                    <td width="100%">
                        <table border="0" width="100%" cellpading="0" cellspacing="0" id="search_menu" style="background-color:#f2f2f2; display:block; ">
                            <tr align='right'>
                             <input name='week_start_date' type='hidden' >
                             <input type="button" name="btnQtyChk" value=" 저장" onClick="GoSave(); " class="btn1_on"/>
                            </tr>
                        </table> 
                    </td>
                    <td width="2" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td>
                </tr>
                <tr height="2"><td colspan="3" style="background-color:#d0d0d0; " onClick="OpenClose(search_menu); $!{resizeFuncCallCode}; "></td></tr>
            </table>
        </td> 
    </tr>

    <input name="search_h" type="hidden" value="45"> ## search 조건 부분 높이 
    <tr><td height="1"></td></tr>
    ## TAB 영역
    <tr>
        <td valign="top">
        ## tab 좌측 여백
        #tabLeft()                
            
            <table id="gridArea" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td>                    

            <table name="grid" width="100%" border="0" cellpading="0" cellspacing="0" class="normal-table">
                <tr>
                    <td >
                        <script>initWiseGrid("WiseGrid", "100%", "300");</script>
                    </td>                     
                </tr> 
            </table> 
            
            <table height="5"><tr><td></td></tr></table>
            <table align="center" border="0" cellpading="0" cellspacing="0" class="normal-table"><tr><td>
                <input type="hidden" name="_moon_service" value="${_moon_service}">
                <input type="hidden" name="_moon_pagenumber" value="$!{_moon_pagenumber}">
                <input type="hidden" name="_user_id" value="$!{_user_id}">
            </td></tr></table>
            
            </td></tr></table>
            
            ## waiting 표시영역
            #waitingArea()
                    
        </td>
    </tr>
</table>

<script>

// 화면 resize
$!{resizeFuncCallCode};
function window.onresize() { $!{resizeFuncCallCode}; }

// 도움말 내용 입력
var helpStr = "◈ Job Change 시간 ";    
helpCont.innerHTML = helpStr;
hDynamicHeight = 0; 


//-----------------------------------------             전역 변수            ----------------------------------------------//

var mode = '';
var class_path = "com.wisegrid.admin.";					
var job_id = 'sc_12020_dailySemifinishedProductPlanAnalysis_psi_pop';
var job_id2= 'sc_12020_dailySemifinishedProductPlanAnalysis_psi';

var GridObj;

var GridHeaderString = "";

var color01 = '188|210|238'; // 연장 배경색
var color02 = '238|180|180'; // 휴동 배경색

var weekCnt = 1;

var str = ''; //본창 공장 조회조건

/******************************************          Action Function         **********************************************/

/*┌──────────────────────────────────┐
  │화면에 '조회'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
function GoSearch(service) 
{
    doQuery();    
}
  
/*┌──────────────────────────────────┐
  │화면에 '저장'를 누르면 호출 Fnc
  └──────────────────────────────────┘*/
function GoSave  (service)
{
	doSave();
}
 

/*******************************************   WiseGrid 초기화 및 설정  *****************************************************/

/*┌────────────────────────────────────────────────────────────┐
  │WiseGrid 오브젝트가 생성되고 초기화된 후 발생하는 
  │JavaScript Event인 Initialize()를 받아 그리드의 헤더를 셋팅한다.
  └────────────────────────────────────────────────────────────┘*/
function init() {
	
	GridObj = document.WiseGrid;
	
    var len = opener.document.frm.selected_plant.length;            
    var cnt = 0;                                             
    for( i = 0 ; i < len ; i++)                              
    {                                                        
        if( opener.document.frm.selected_plant[i].checked == true ) 
        {                                                    
            if( cnt > 0 ) str += "','";                      
            str += opener.document.frm.selected_plant[i].value;		
            cnt++;	                                        
        }                                                    
    }		                                                
    if( cnt == 0 )                                           
    {                                                        
        alert("선택된 공장이 없습니다!!");                   
        return;                                              
    }                                                        
                                                                
	
	setProperty(GridObj); //WiseGrid Default설정 부분 (WiseGrid_Property.js파일 내에 선언되어 있다.)
    setDefault();        //화면 기본 설정 
    setHeader(GridObj);  //해더생성 
}


/*┌──────────────────────────────────┐
  │해더생성
  │-.fnc:해더를 가져오는 결과값이 return되면 호출되는 Fnc명
  └──────────────────────────────────┘*/
   function setHeader(GridObj) 
   {        
       commonUtil.getCodeList("job_id", job_id , "gird_header_list",defaultHeader); 
       
   }
   

/*┌──────────────────────────────────┐
  │화면 기본 설정 부분.
  └──────────────────────────────────┘*/
function setDefault()
{
}
 
/*┌──────────────────────────────────┐
  │DB에 등록된 화면 해더 정보를 가져온다.
  └──────────────────────────────────┘*/
   function defaultHeader(result)
   {
       var arrHeader = '';
       for( var i=0 ;i<result.length ;i++) //전체 Row만큼 반복 한다.
       {
           arrHeader = result[i].split('!%!');
           GridObj.AddHeader(arrHeader[1]  ,arrHeader[2]  ,arrHeader[3]  ,arrHeader[4]  ,arrHeader[5]  ,arrHeader[6]);        
       }
       commonUtil.getCodeList("", "" , "daily_header",headerResult); //날짜형 해더를 만들어 준다.

   }     
 
/*┌──────────────────────────────────┐
  │날짜 형태의 해더에 명을 생성한다.
  └──────────────────────────────────┘*/
   function headerResult(result)
   {
       var dateArray = ''; //날짜Row를 '!%!'기준으로 배열을 만들기 위한 변수.
       var dayCount  = 1;  //날짜 순위
       if(opener.document.all.checked_weekly[0].checked) weekNo=1;
       if(opener.document.all.checked_weekly[1].checked) weekNo=2;
       if(opener.document.all.checked_weekly[2].checked) weekNo=3;
       
       headerCount=result.length;       
       
       for( var i=0 ;i<result.length ;i++) //전체 Row만큼 반복 한다.
       {
            if( result[i].substr(0,1)==weekNo) //화면에 선택된 주차에 대한 것만 봅느다.
            {
                dateArray = '';
                dateArray = result[i].split('!%!'); //'!%!'로 구분된 데이터를 split하여 배열로 저장한다.
                
                if( dayCount=='1' ) //선택된 주차의 월요일을 입력한다.
                    document.all.week_start_date.value = dateArray[7];

                //해더 그룹생성
                GridObj.AddGroup("GRP_DATE"+dayCount,dateArray[1]+' '+dateArray[2]+'/'+dateArray[3]+'('+dateArray[4]+')');  //날짜 그룹
                GridObj.AppendHeader("GRP_DATE"+dayCount,"D0"+dayCount+"A");
                GridObj.AppendHeader("GRP_DATE"+dayCount,"D0"+dayCount+"B");
                GridObj.AppendHeader("GRP_DATE"+dayCount,"D0"+dayCount+"C"); 
                dayCount++;
            } 
       }
       GridObj.BoundHeader()    

       GridObj.SetColHide("CRUD", true);
       GridObj.SetColHide("PLANT_ID", true);
       GridObj.SetColHide("LINE_ID", true);
       GridObj.SetColHide("PROC_ID", true);
       GridObj.SetColHide("PROD_VER", true);
       GridObj.SetColHide("VERSION", true);
       GridObj.SetColHide("ITEM_NAME", true);
       GridObj.SetColHide("WEEK_START_DATE", true);
       
       GridObj.SetColHide("BG01A", true);  GridObj.SetColHide("BG02A", true);  GridObj.SetColHide("BG03A", true);  GridObj.SetColHide("BG04A", true);  GridObj.SetColHide("BG05A", true);  GridObj.SetColHide("BG06A", true);  GridObj.SetColHide("BG07A", true);
       GridObj.SetColHide("BG01B", true);  GridObj.SetColHide("BG02B", true);  GridObj.SetColHide("BG03B", true);  GridObj.SetColHide("BG04B", true);  GridObj.SetColHide("BG05B", true);  GridObj.SetColHide("BG06B", true);  GridObj.SetColHide("BG07B", true);
       GridObj.SetColHide("BG01C", true);  GridObj.SetColHide("BG02C", true);  GridObj.SetColHide("BG03C", true);  GridObj.SetColHide("BG04C", true);  GridObj.SetColHide("BG05C", true);  GridObj.SetColHide("BG06C", true);  GridObj.SetColHide("BG07C", true);

   	   GridObj.SetCRUDMode("CRUD", "추가", "수정", "삭제"); //수정,삭제,추가 구분 부분.
       
       doQuery();
   }
  
  
  

/***********************************************   WiseGrid 통신  **********************************************************/

/*┌──────────────────────────────────┐
  │첫번째 그리드의 조회 쿼리를 호출 Fnc
  └──────────────────────────────────┘*/
function doQuery() {

    var servlet_url = Project_name+"/servlet/com.wisegrid.admin."+job_id;
    
    //WiseGrid가 서버에 전송할 mode를 셋팅한다.
    GridObj.SetParam("mode", "search");
    GridObj.Setparam("plant_id",str);
    GridObj.Setparam("week_start_date",document.all.week_start_date.value);
    GridObj.SetParam("_user_id",document.all._user_id.value);           
    
    //WiseGrid가 서버와 통신시에 데이터를 전달한
    GridObj.DoQuery(servlet_url, "CRUD");

}

/*┌──────────────────────────────────┐
  │저장 호출 Fnc
  └──────────────────────────────────┘*/	
function doSave() {
    var servlet_url = Project_name+"/servlet/com.wisegrid.admin."+job_id2;
    
    //WiseGrid가 서버에 전송할 mode를 셋팅한다.
    GridObj.SetParam("mode", "cal");
    GridObj.SetParam("_user_id",document.all._user_id.value);
    
    //WiseGrid가 서버와 통신시에 데이터를 전달한
    GridObj.DoQuery(servlet_url, "CRUD");
}

/* INSERT */
function doInsert() {
    
    GridObj.SetParam("mode", "insert");

    GridObj.DoQuery(servlet_url, "SELECTED");
}

/* UPDATE */
function doUpdata() {
	
    GridObj.SetParam("mode", "update");

    GridObj.DoQuery(servlet_url, "SELECTED");
}

/* DELETE */
function doDelete() {
    
    GridObj.SetParam("mode", "delete");

    GridObj.DoQuery(servlet_url, "SELECTED");
}

/*******************************************   WiseGrid 통신 후  설정  ******************************************************/

/*┌──────────────────────────────────┐
  │데이터 조회가 정상적으로 완료되면 발생되는 Event에 대한 Fnc
  └──────────────────────────────────┘*/
function GridEndQuery() 
{
    var mode = GridObj.GetParam("mode");
    var error_msg = '';
    
    if(mode == "search") //조회가 완료된 경우
    {
        if(GridObj.GetStatus() == "true") 
        {                           
        	                                
            //데이터를 그룹핑 한다.                                                     
            GridObj.SetGroupMerge("PLANT_NAME,LINE_NAME");             
            gridColSet(GridObj);
						
        } else    
        { 
            error_msg = GridObj.GetMessage(); 
            alert(error_msg);            
        }
    }
}


/*********************************************   WiseGrid Event   *********************************************************/

/*┌──────────────────────────────────┐
  │그리드의 데이터가 변경 되었을 경우 처리되는 Fnc
  └──────────────────────────────────┘*/
function GridChangeCell(strColumnKey, nRow) 
{

} 

/*┌──────────────────────────────────┐
  │그리드의 원 클릭 이벤트
  └──────────────────────────────────┘*/
function GridCellClick(strColumnKey, nRow){     

}        


/*********************************************   기타 Function   **********************************************************/

/*┌──────────────────────────────────┐
  │그리드의 사이즈 조절 Fnc
  └──────────────────────────────────┘*/
function setWiseGridAutoResize( tab_h, table_h ){
    
    var maxWidthValue;
    var maxHeightValue;
    
    if (document.layers) {
        //Nescape
        maxWidthValue = window.innerWidth;
        maxHeightValue = window.innerHeight;
    }
    if (document.all) {
        //explore
        maxWidthValue = document.body.clientWidth;
        maxHeightValue = document.body.clientHeight;
    } 
    
    var tabHeightValue = Number(maxHeightValue) - Number(tab_h) ; 
    var tableHeightValue = Number(maxHeightValue) - Number(table_h) ; 
    
    var search_h = document.frm.search_h.value; 
    if( search_menu.style.display == "none" ) 
    { 
        tabHeightValue += Number(search_h); 
        tableHeightValue += Number(search_h); 
    } 
    
    // 화면 size 축소 시 화면이 너무 작아 그리드 크기가 음수가 되면 에러가 나므로 그 경우 무조건 1로 세팅 
    // ==> 화면이 더이상 축소되지 않음 
    if( tabHeightValue < 1 ) 
        tabHeightValue = 1; 
    if( tableHeightValue < 1 ) 
        tableHeightValue = 1; 
    
    //tabPage1.style.height = tabHeightValue + "px"; 
    //tbMain.style.height = tableHeightValue + "px"; 
	document.WiseGrid.height = tableHeightValue + "px"; 	 
        
}     
 
/*┌──────────────────────────────────┐
  │주차 선택 Fnc
  └──────────────────────────────────┘*/	
function onChangeDate(obj){
	alert("!!");
	GridObj.ClearGrid();
	setHeader(GridObj);
	//doQuery();
	//GridObj2.ClearGrid();
	//setHeader2(GridObj2);
	//doQuery2();
}


 /*┌──────────────────────────────────┐
   │그리드 컬럼 Set
   └──────────────────────────────────┘*/
    function gridColSet(obj)    
    {
        var rowLeng = obj.GetRowCount();
        var work_allocation= new Array();
        
        for( var row=0 ; row<rowLeng ; row++ ) //row수만큼 반복
        {
            for( var col=1 ;col<=7 ;col++) 
            {
                
                //보정row이지만 근무조가 없는경우는 보정 불가능
                //단, 근무조가없지만 수량이 있는 경우는 보정 가능하다.
                work_allocation[0]=obj.GetCellValue('BG0'+col+'A' ,row);  //근무조정보를 가져온다.
                work_allocation[1]=obj.GetCellValue('BG0'+col+'B' ,row);
                work_allocation[2]=obj.GetCellValue('BG0'+col+'C' ,row);

                if(work_allocation[0]=='null') 
                { 
                    obj.SetCellActivation("D0"+col+"A", row, 'activatenoedit');    
                    obj.SetCellFontBold(  "D0"+col+"A", row, 'false');   
                    obj.SetCellFgColor(   'D0'+col+'A', row, '174|174|174'); 
                }
                if(work_allocation[1]=='null') 
                { 
                    obj.SetCellActivation("D0"+col+"B", row, 'activatenoedit');    
                    obj.SetCellFontBold(  "D0"+col+"B", row, 'false');    
                    obj.SetCellFgColor(   'D0'+col+'B', row, '174|174|174'); 
                }
                if(work_allocation[2]=='null') 
                { 
                    obj.SetCellActivation("D0"+col+"C", row, 'activatenoedit');    
                    obj.SetCellFontBold(  "D0"+col+"C", row, 'false');    
                    obj.SetCellFgColor(   'D0'+col+'C', row, '174|174|174'); 
                }
            }
        }        
    }
	
</script> 
