package com.wisegrid.admin;                                                                                                                                                                                                                                                                                                                                                            import java.io.IOException;                                                                                                  import java.io.PrintWriter;                                                                                                  import java.sql.SQLException;                                                                                                import java.util.ArrayList;                                                                                                                                                                                                                               import javax.servlet.ServletException;                                                                                       import javax.servlet.http.HttpServlet;                                                                                       import javax.servlet.http.HttpServletRequest;                                                                                import javax.servlet.http.HttpServletResponse;                                                                                                                                                                                                            import com.zionex.t3sinc.common.CommonUtil;                                                                                  import xlib.cmc.GridData;                                                                                                    import xlib.cmc.OperateGridData;                                                                                                                                                                                                                                                                                                                                                       import java.sql.Connection;                                                                                                  import java.sql.ResultSet;                                                                                                   import java.sql.Statement;                                                                                                   import java.util.HashMap;                                                                                                    import java.util.Iterator;                                                                                                   import java.util.LinkedList;                                                                                                 import java.util.Map;                                                                                                                                                                                                                                     import com.zionex.t3sinc.util.db.SincDatabaseUtility;                                                                        /**                                                                                                                           *                                                                                                                            * @author iCOMPIA CORP.                                                                                                      */                                                                                                                          public class ip_03030_Long_Term_Hawa_Planning extends HttpServlet {                                                                                                                                                                                          	private static final long serialVersionUID = -419201700278107216L;                                                       	                                                                                                                         	Connection 	conn 	= null;                                                                                              	Statement 	stmt	= null;                                                                                              	ResultSet	rs		= null;	   	ResultSet	rs2		= null;		String 		sql 	= null;                                                                                              	//Map sessionMap 	= new HashMap();                                                                                     	                                                                                                                         	SincDatabaseUtility databaseUtility = new SincDatabaseUtility();	                                                                                                                                                                                  	public void doPost(HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException {               		GridData gdReq = null;                                                                                               		GridData gdRes = null;                                                                                                                                                                                                                                    System.out.println("START...");                                                                                                                                                                                                                   		// Encode Type; UTF-8                                                                                                		req.setCharacterEncoding("UTF-8");                                                                                   		res.setContentType("text/html;charset=UTF-8");                                                                       		                                                                                                                     		PrintWriter out = res.getWriter();                                                                                   		try {                                                                                                                			// WISEGRID_DATA Param WiseGridG                                                                                 			String rawData = req.getParameter("WISEGRID_DATA");                                                              			                                                                                                                 			gdReq = OperateGridData.parse(rawData);                                                                                                                                                                                                       			String mode = gdReq.getParam("mode");                                                                            			System.out.println("Test :: mode = " + mode);                                                                                                                                                                                                 			if (mode.equals("search")) //                                                                                    				gdRes = doQuery(gdReq);                                                                                      			else if (mode.equals("search2")) //                                                                               				gdRes = doQuery2(gdReq); 			else if (mode.equals("save")) //                                                                               				gdRes = doSave(gdReq);			else if (mode.equals("save2")) //                                                                               				gdRes = doSave2(gdReq);			else if (mode.equals("doIf")) //                                                                               				gdRes = doIf(gdReq);								} catch (Exception e) {                                                                                              			gdRes = new GridData();                                                                                          			gdRes.setMessage("Error: " + e.getMessage());                                                                    			gdRes.setStatus("false");                                                                                        			e.printStackTrace();                                                                                             		} finally {                                                                                                          			try {                                                                                                            				//                                                                                                           				OperateGridData.write(gdRes, out);                                                                           			} catch (Exception e) {                                                                                          				e.printStackTrace();                                                                                         			}                                                                                                                		}                                                                                                                    	}                                                                                                                        		// DW 1 조회  쿼리	public GridData doQuery(GridData gdReq) throws Exception {                                                               		                                                                                                                     		GridData gdRes = new GridData();		                                                                             		int rowCount = 0;                                                                                                                                                                                                                                 		try {                                                                                                                			gdRes = OperateGridData.cloneResponseGridData(gdReq);                                                            			                                                                                                                 			String item_type		= gdReq.getParam("item_type");                                                            			String version			= gdReq.getParam("version"); 			String sales_cat05		= gdReq.getParam("sales_cat05");									String paramKey   ="version!%!item_type!%!sales_cat05";                                                                      			String paramCode  = version+"!%!"+item_type+"!%!"+sales_cat05;                                                                                                                                                                                                			String query_id   = "ip_03030_Long_Term_Hawa_Planning";                                                                                                                             			ArrayList<ArrayList<String>> qResult = new CommonUtil().getSelQeury(paramKey, paramCode, query_id);              			                                                                                                                 			rowCount = qResult.size();                                                                                                                                                                                                                    			//                                                                                                               			if (rowCount == 0) {                                                                                             				gdRes.addParam("mode", "search");		                                                                     				gdRes.setMessage("...");                                                                                     				gdRes.setStatus("true");                                                                                     				return gdRes;                                                                                                			}                                                                                                                			/*선택구분 리스트를 추출하여 콤보리스트 생성 */			String query_id2 = "sel_dmd_list_ip03030"; 			System.out.println("getSelQeury : " + query_id2);			ArrayList<ArrayList<String>> selDmdList = new CommonUtil().getSelQeury("", "", query_id2);						int arrIdx = selDmdList.size();						String[] selDmdIdList = new String[arrIdx];			String[] selDmdNameList = new String[arrIdx];						System.out.println("출고 사업장 콤보리스트 생성");			for ( int i = 0 ; i < arrIdx ; i++ ){				selDmdIdList[i] = selDmdList.get(i).get(0);   //선택구분 ID 콤보리스트 생성				selDmdNameList[i] = selDmdList.get(i).get(1); // 선택구분 이름 콤보리스트 생성			}						System.out.println("출고 사업장 컬럼에 콤보리스트 set");			gdRes.getHeader("SEL_DMD").setComboValues(selDmdNameList, selDmdIdList );		//선택구분   콤보리스트 출고 사업장 컬럼에 set															for (int i = 0; i < rowCount; i++) {                                                                             				gdRes.getHeader("CRUD"			).addValue( "", "");				gdRes.getHeader("SELECTED"		).addValue("0", "");     								gdRes.getHeader("IF_FLAG"		).addValue(qResult.get(i).get(0  ),"");   				gdRes.getHeader("ITEM_ID"		).addValue(qResult.get(i).get(1  ),"");                                      				gdRes.getHeader("ITEM_NAME" 	).addValue(qResult.get(i).get(2  ),"");                                     				gdRes.getHeader("TERM_VAL" 		).addValue(qResult.get(i).get(3  ),"");                                     				gdRes.getHeader("OPER_VAL"	 	).addValue(qResult.get(i).get(4  ),"");				gdRes.getHeader("BASE_STOCK" 	).addValue(qResult.get(i).get(5  ),"");				gdRes.getHeader("SEL_DMD" 		).addSelectedHiddenValue(qResult.get(i).get(6));//출고사업장								gdRes.getHeader("AVL_DAY" 		).addValue(qResult.get(i).get(7  ),"");				gdRes.getHeader("PROD_TERM" 	).addValue(qResult.get(i).get(8  ),"");				gdRes.getHeader("RECEIPT_M" 	).addValue(qResult.get(i).get(9  ),"");                                     				gdRes.getHeader("RECEIPT_M2" 	).addValue(qResult.get(i).get(10  ),"");                                     				gdRes.getHeader("RECEIPT_M3" 	).addValue(qResult.get(i).get(11  ),"");                                     				gdRes.getHeader("MON_M01" 		).addValue(qResult.get(i).get(12  ),"");				gdRes.getHeader("MON_M02" 		).addValue(qResult.get(i).get(13  ),"");                                     				gdRes.getHeader("TOT_AVL_DAY" 	).addValue(qResult.get(i).get(14 ),"");                                     				                                     				gdRes.getHeader("SALES_MEAN_3WEEK_ETC" 	).addValue(qResult.get(i).get(15 ),"");                                     				gdRes.getHeader("SALES_MEAN_3MON_TA" 	).addValue(qResult.get(i).get(16 ),"");                                     				gdRes.getHeader("SALES_PY_MON_CUM_TA" 	).addValue(qResult.get(i).get(17 ),"");                                     				gdRes.getHeader("SALES_USER" 			).addValue(qResult.get(i).get(18 ),""); 				gdRes.getHeader("LEAD_TIME" 			).addValue(qResult.get(i).get(19 ),"");                                     				gdRes.getHeader("MINMPSQTY" 			).addValue(qResult.get(i).get(20 ),"");                                     				gdRes.getHeader("BOX_PER_PALET" 		).addValue(qResult.get(i).get(21 ),"");                                     				gdRes.getHeader("BOX_DEMAND" 			).addValue(qResult.get(i).get(22 ),"");                                     				gdRes.getHeader("PR_QTY" 				).addValue(qResult.get(i).get(23 ),""); 				gdRes.getHeader("MEINS" 				).addValue(qResult.get(i).get(24 ),""); 				gdRes.getHeader("IPGO_DATE" 			).addValue(qResult.get(i).get(25 ),"");				gdRes.getHeader("PR_NO" 				).addValue(qResult.get(i).get(26 ),"");                                     				gdRes.getHeader("IF_MSGS" 				).addValue(qResult.get(i).get(27 ),"");	                                  											}                                                                                                                                                                                                                                             			gdRes.addParam("mode", "search");		                                                                         			gdRes.setMessage("");                                                                                            			gdRes.setStatus("true");                                                                                                                                                                                                                      		} catch (Exception e) {                                                                                              			throw e;                                                                                                         		}                                                                                                                    				                                                                                                             		return gdRes;                                                                                                        	}                                                                                                                        	// DW 2 조회  쿼리	public GridData doQuery2(GridData gdReq) throws Exception {                                                               		                                                                                                                     		GridData gdRes = new GridData();		                                                                             		int rowCount = 0;                                                                                                    						try {                                                                                                                			gdRes = OperateGridData.cloneResponseGridData(gdReq);  						                                                           			String version	= gdReq.getParam("version"); 			String item_id	= gdReq.getParam("item_id");					                                                                                                                 			String paramKey   ="item_id!%!version";                                                                      			String paramCode  = item_id+"!%!"+version;                                                                                                                                                                                                			String query_id   = "ip_03030_Long_Term_Hawa_Planning_DW2";                                                                                                                                                                                          			ArrayList<ArrayList<String>> qResult = new CommonUtil().getSelQeury(paramKey, paramCode, query_id);              			                                                                                                                 			rowCount = qResult.size();                                                                                                                                                                                                                    			//                                                                                                               			if (rowCount == 0) {                                                                                             				gdRes.addParam("mode", "search2");		                                                                     				gdRes.setMessage("...");                                                                                     				gdRes.setStatus("true");                                                                                     				return gdRes;                                                                                                			}                                                                                                                			                                                                                                                 			for (int i = 0; i < rowCount; i++) {          								gdRes.getHeader("CRUD"		).addValue( "", "");				gdRes.getHeader("ITEM_ID"	).addValue(qResult.get(i).get(0 ),"");                                      				gdRes.getHeader("ITEM_NAME" ).addValue(qResult.get(i).get(1 ),"");                                     				gdRes.getHeader("PR_NO"		).addValue(qResult.get(i).get(2 ),"");  				gdRes.getHeader("PR_DATE"	).addValue(qResult.get(i).get(3 ),"");  				gdRes.getHeader("PR_QTY"	).addValue(qResult.get(i).get(4 ),"");                                      				gdRes.getHeader("PO_NO"		).addValue(qResult.get(i).get(5 ),"");				gdRes.getHeader("PO_DATE"	).addValue(qResult.get(i).get(6 ),""); 				gdRes.getHeader("PO_QTY"	).addValue(qResult.get(i).get(7 ),"");								//gdRes.getHeader("HBL_NO"	).addValue(qResult.get(i).get(8 ),"");				gdRes.getHeader("BL_NO"		).addValue(qResult.get(i).get(8 ),"");								gdRes.getHeader("BL_QTY"	).addValue(qResult.get(i).get(9),"");				gdRes.getHeader("GUBN"		).addValue(qResult.get(i).get(10),"");  				gdRes.getHeader("LEAD_1"	).addValue(qResult.get(i).get(11),"");  				gdRes.getHeader("LEAD_2"	).addValue(qResult.get(i).get(12),"");  				gdRes.getHeader("LEAD_3"	).addValue(qResult.get(i).get(13),"");  				gdRes.getHeader("LEAD_4"	).addValue(qResult.get(i).get(14),""); 				gdRes.getHeader("IPGO_DATE"	).addValue(qResult.get(i).get(15),"");				gdRes.getHeader("EXPT_DATE"	).addValue(qResult.get(i).get(16),"");                                      				gdRes.getHeader("LEAD_TIME"	).addValue(qResult.get(i).get(17),"");                                      				gdRes.getHeader("SEQ"		).addValue(qResult.get(i).get(18),"");                                      				gdRes.getHeader("BIGO"		).addValue(qResult.get(i).get(19),"");      				gdRes.getHeader("BIGO2"		).addValue(qResult.get(i).get(20),"");   								gdRes.getHeader("TEXT_1"	).addValue(qResult.get(i).get(21),""); 				gdRes.getHeader("TEXT_2"	).addValue(qResult.get(i).get(22),""); 				gdRes.getHeader("TEXT_3"	).addValue(qResult.get(i).get(23),""); 				gdRes.getHeader("TEXT_4"	).addValue(qResult.get(i).get(24),""); 				gdRes.getHeader("TEXT_5"	).addValue(qResult.get(i).get(25),""); 				gdRes.getHeader("TEXT_6"	).addValue(qResult.get(i).get(26),""); 				gdRes.getHeader("TEXT_7"	).addValue(qResult.get(i).get(27),""); 				}                                                                                                                                                                                                                                             			gdRes.addParam("mode", "search2");		                                                                         			gdRes.setMessage("");                                                                                            			gdRes.setStatus("true");                                                                                                                                                                                                                      		} catch (Exception e) {                                                                                              			throw e;                                                                                                         		}                                                                                                                    				                                                                                                             		return gdRes;                                                                                                        	}                			public GridData doSave(GridData gdReq) throws Exception {		System.out.println("doSave() start!!!");		conn = databaseUtility.getConnection("t3sinc"); // DB Connection		stmt = conn.createStatement(); // statement 객체 생성		GridData gdRes = new GridData(); // WiseGrid 객체생성		int rowCount = 0; // CRUD 컬럼 row 수				System.out.println("Total Row Count : " + gdReq.getHeader("ITEM_ID").getRowCount());		try {			// 화면에서 전달받은 "CRUD"의 row 수를 가져온다.			rowCount = gdReq.getHeader("CRUD").getRowCount();						if(rowCount == 0) {				gdRes.addParam("mode", "save");				gdRes.setMessage("성공적으로 작업하였습니다._저장데이터 없음.");				gdRes.setStatus("true");				return gdRes;			}						String user_id		= gdReq.getParam("user_id");			String version		= gdReq.getParam("version");						System.out.println("Row Count : " + rowCount);			String sql;			String sql2;												//해당 버젼이 있을경우에는 (MERGE 문 업데이트나 인설트를) 실행!!				sql  = "	MERGE INTO APS_PR_PLAN AP  /*+ bypass_ujvc*/ 																	\n";			sql += "	USING( 																											\n";				sql2  = "	MERGE INTO ITEM_MST IM  /*+ bypass_ujvc*/ 																		\n";			sql2 += "	USING( 																											\n";						boolean flag = false;						// 데이터 셋팅			for (int i = 0; i < rowCount; i++) {								if( flag){						sql  += "UNION ALL \n";					//sql2 += "union all \n";					//sql3 += "union all \n";				}				flag = true;								// 콤보리스트 변수 할당				String sel_dmd = "";				if(gdReq.getHeader("SEL_DMD").getSelectedIndex(i) > -1){												sel_dmd = gdReq.getHeader("SEL_DMD").getComboHiddenValues()[gdReq.getHeader("SEL_DMD").getSelectedIndex(i)];				}								//파라미터를 변수에 적용!!									 								//-------------------------------------------------------------------------------------------------------------------				sql +="			SELECT	   '" +	version															+ "'      AS VERSION, 		\n"; 				sql +="					   '1300'   	  																  AS PLANT_ID,   	\n";				sql +="					   '" + gdReq.getHeader("ITEM_ID"		).getValue(i)   				+ "'   	  AS ITEM_ID,   	\n";									sql += "				   '" + sel_dmd															+ "'	  AS SEL_DMD,      	\n";				sql +="					   '" + user_id  									  					+ "' 	  AS MADE_BY		\n";						sql +="			from   DUAL 																			   					\n";						              // --------------------------------------------------------------------------------------------------------------------						}				//-----------------------------Merge Into 1-----------------------------	-----------------------------------------------------			sql += ") AP1 														   		\n";			sql += "ON (AP.VERSION    		= AP1.VERSION    						   	\n";			sql += "AND AP.PLANT_ID     	= AP1.PLANT_ID          				   	\n";			sql += "AND AP.ITEM_ID     		= AP1.ITEM_ID)          				   	\n";						sql += "when matched then update set            					   		\n";			sql += "     AP.SEL_DMD   	= AP1.SEL_DMD									\n";		        //---------------------------------------------------------------------------------------------------------------------------						System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println(sql);			System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println("executeQuery 실행!!!");			rs = databaseUtility.executeQuery(stmt, sql);			System.out.println("executeQuery 종료!!!");					flag = false;						// 데이터 셋팅			for (int i = 0; i < rowCount; i++) {									if( flag){						sql2 += "UNION	ALL \n"; 					}					flag = true;								//-------------------------------------------------------------------------------------------------------------------					sql2 +="			SELECT	   '" + gdReq.getHeader("ITEM_ID"		).getValue(i)   		+ "'   	  AS ITEM_ID,   	\n";									 					sql2 +="					   '" + gdReq.getHeader("MINMPSQTY"		).getValue(i)   		+ "'   	  AS MOQ			\n";									sql2 +="			from   DUAL 																		   				\n";							               //--------------------------------------------------------------------------------------------------------------------			}								//-----------------------------Merge Into 2-----------------------------	-----------------------------------------------------			sql2 += ") IM1 														   		\n";			sql2 += "ON (IM.ITEM_ID    		= IM1.ITEM_ID)    						   	\n";			sql2 += "when matched then update set            					   		\n";			sql2 += "IM.MOQ    = IM1.MOQ      											\n";  				        //---------------------------------------------------------------------------------------------------------------------------									System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println(sql2);			System.out.println("-----------------------------------------------QUERY-----------------------------------------------");						/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////						System.out.println("executeQuery 실행!!!");			rs = databaseUtility.executeQuery(stmt, sql2);			System.out.println("executeQuery 종료!!!");						/*			 * 화면에 전달할 파라미터를 설정한다. 메세지를 셋팅한다. Status를 설정한다			 */			gdRes.addParam("mode", "save");			gdRes.setMessage("성공적으로 작업하였습니다.");			gdRes.setStatus("true");					}catch (Exception e) {			throw e;		}finally {            databaseUtility.close(conn, stmt, rs);           }        System.out.println("doSave() end!!!");		return gdRes;	}					public GridData doSave2(GridData gdReq) throws Exception {		System.out.println("doSave2() start!!!");		conn = databaseUtility.getConnection("t3sinc"); // DB Connection		stmt = conn.createStatement(); // statement 객체 생성		GridData gdRes = new GridData(); // WiseGrid 객체생성		int rowCount = 0; // CRUD 컬럼 row 수		try {			// 화면에서 전달받은 "CRUD"의 row 수를 가져온다.			rowCount = gdReq.getHeader("CRUD").getRowCount();						if(rowCount == 0) {				gdRes.addParam("mode", "save2");				gdRes.setMessage("성공적으로 작업하였습니다._저장데이터 없음.");				gdRes.setStatus("true");				return gdRes;			}						String user_id		= gdReq.getParam("user_id");			String version		= gdReq.getParam("version");						System.out.println("Row Count : " + rowCount);			String sql;			String sql2;									//해당 버젼이 있을경우에는 (MERGE 문 업데이트나 인설트를) 실행!!				sql  = "	MERGE INTO USER_PR_MSG  MG 							\n";			sql += "	USING( 												\n";						boolean flag = false;						for (int i = 0; i < rowCount; i++) {								if( flag){						sql  += "UNION ALL \n";								}				flag = true;								//파라미터를 변수에 적용!!									//-------------------------------------------------------------------------------------------------------------------				sql +="			SELECT	   '" +	version															+ "'      AS VERSION, 	\n";				sql +="					   '" + gdReq.getHeader("PR_NO"		).getValue(i)   					+ "'   	  AS PR_NO,   	\n";				sql +="					   '" + gdReq.getHeader("SEQ"		).getValue(i)   					+ "'   	  AS SEQ,  		\n";				sql +="					   '" + gdReq.getHeader("BIGO"		).getValue(i)   					+ "'   	  AS MSG,  		\n";				sql +="					   '" + gdReq.getHeader("BIGO2"		).getValue(i)   					+ "'   	  AS MSG2,  	\n";				sql	+=	"							SYSDATE																  AS MADE_DTTM, \n";				sql +="					   '" + user_id  									  					+ "' 	  AS MADE_BY	\n";				sql +="			from   DUAL 																			   				\n";						              // --------------------------------------------------------------------------------------------------------------------						}				//-----------------------------Merge Into 1-----------------------------	-----------------------------------------------------			sql += ") MG1 														   	\n";			sql += "ON (MG.VERSION    	= MG1.VERSION    							\n";			sql += "AND MG.PR_NO     	= MG1.PR_NO          				   		\n";			sql += "AND MG.SEQ     		= MG1.SEQ)          				   		\n";			sql += "when matched then update set            					   	\n";						sql += "     MG.MSG	 	  	= MG1.MSG,      							\n"; 			sql += "     MG.MSG2	 	= MG1.MSG2,      							\n"; 			sql += "     MG.MADE_DTTM	= MG1.MADE_DTTM,      						\n"; 			sql += "     MG.MADE_BY	 	= MG1.MADE_BY      							\n"; 			sql += "when not matched then insert(VERSION, PR_NO, SEQ, MSG, MSG2, MADE_DTTM, MADE_BY) 					 \n";			sql += "values  (MG1.VERSION,MG1.PR_NO, MG1.SEQ, MG1.MSG,  MG1.MSG2, SYSDATE, MG1.MADE_BY) 					 \n";		        //---------------------------------------------------------------------------------------------------------------------------						System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println(sql);			System.out.println("-----------------------------------------------QUERY-----------------------------------------------");									//해당 버젼이 있을경우에는 (MERGE 문 업데이트나 인설트를) 실행!!				sql2  = "	MERGE INTO MAT_TIME  MG 							\n";			sql2 += "	USING( 												\n";						boolean flag2 = false;						for (int i = 0; i < rowCount; i++) {								if( flag2){						sql2  += "UNION ALL \n";								}				flag2 = true;								//파라미터를 변수에 적용!!									//-------------------------------------------------------------------------------------------------------------------				sql2 +="			SELECT	   '" + gdReq.getHeader("PR_NO"		).getValue(i)   					+ "'   	  AS PR_NO,   	\n";				sql2 +="					   '" + gdReq.getHeader("BL_NO"		).getValue(i)   					+ "'   	  AS BL_NO,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_1"	).getValue(i)   					+ "'   	  AS TEXT_1,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_2"	).getValue(i)   					+ "'   	  AS TEXT_2,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_3"	).getValue(i)   					+ "'   	  AS TEXT_3,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_4"	).getValue(i)   					+ "'   	  AS TEXT_4,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_5"	).getValue(i)   					+ "'   	  AS TEXT_5,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_6"	).getValue(i)   					+ "'   	  AS TEXT_6,  	\n";				sql2 +="					   '" + gdReq.getHeader("TEXT_7"	).getValue(i)   					+ "'   	  AS TEXT_7  	\n";								sql2 +="			from   DUAL 																			   				\n";						              // --------------------------------------------------------------------------------------------------------------------						}				//-----------------------------Merge Into 1-----------------------------	-----------------------------------------------------			sql2 += ") MG1 														   	\n";			sql2 += "ON (MG.PR_NO    	= MG1.PR_NO    								\n";			sql2 += "AND MG.BL_NO     	= MG1.BL_NO)          				   		\n";			sql2 += "when matched then update set            					   	\n";						sql2 += "     MG.TEXT_1	 	  	= MG1.TEXT_1,      						\n"; 			sql2 += "     MG.TEXT_2	 	  	= MG1.TEXT_2,      						\n"; 			sql2 += "     MG.TEXT_3	 	  	= MG1.TEXT_3,      						\n"; 			sql2 += "     MG.TEXT_4	 	  	= MG1.TEXT_4,      						\n"; 			sql2 += "     MG.TEXT_5	 	  	= MG1.TEXT_5,      						\n"; 			sql2 += "     MG.TEXT_6	 	  	= MG1.TEXT_6,      						\n"; 			sql2 += "     MG.TEXT_7	 	  	= MG1.TEXT_7      						\n"; 						sql2 += "when not matched then insert(PR_NO, BL_NO, TEXT_1, TEXT_2, TEXT_3, TEXT_4, TEXT_5, TEXT_6, TEXT_7) 	\n";			sql2 += "values  (MG1.PR_NO,MG1.BL_NO, MG1.TEXT_1, MG1.TEXT_2,  MG1.TEXT_3, MG1.TEXT_4, MG1.TEXT_5, MG1.TEXT_6, MG1.TEXT_7) 		\n";		        //---------------------------------------------------------------------------------------------------------------------------						System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println(sql2);			System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println("executeQuery 실행!!!");			rs  = databaseUtility.executeQuery(stmt, sql);			rs2 = databaseUtility.executeQuery(stmt, sql2);			System.out.println("executeQuery 종료!!!");						/*			 * 화면에 전달할 파라미터를 설정한다. 메세지를 셋팅한다. Status를 설정한다			 */			gdRes.addParam("mode", "save2");			gdRes.setMessage("성공적으로 작업하였습니다.");			gdRes.setStatus("true");					}catch (Exception e) {			throw e;		}finally {            databaseUtility.close(conn, stmt, rs);             databaseUtility.close(conn, stmt, rs2);        }        System.out.println("doSave2() end!!!");		return gdRes;	}		public GridData doIf(GridData gdReq) throws Exception {		System.out.println("doIf() start!!!");		conn = databaseUtility.getConnection("t3sinc"); // DB Connection		stmt = conn.createStatement(); // statement 객체 생성		GridData gdRes = new GridData(); // WiseGrid 객체생성		int rowCount = 0; // CRUD 컬럼 row 수				System.out.println("Total Row Count : " + gdReq.getHeader("ITEM_ID").getRowCount());		try {			// 화면에서 전달받은 "CRUD"의 row 수를 가져온다.			rowCount = gdReq.getHeader("ITEM_ID").getRowCount();						if(rowCount == 0) {				gdRes.addParam("mode", "doIf");				gdRes.setMessage("성공적으로 작업하였습니다._저장데이터 없음.");				gdRes.setStatus("true");				return gdRes;			}			System.out.println("Row Count : " + rowCount);						String version		= gdReq.getParam("version");			String user_id		= gdReq.getParam("user_id");			String sql;						sql   = "MERGE INTO APS_PR_PLAN T1	 	/*+ bypass_ujvc*/       	 \n";			sql  += "USING(							                 			 \n";						boolean flag = false;						// 데이터 셋팅			for (int i = 0; i < rowCount; i++) {				if( flag){						sql  += "union all \n";						}					flag = true;										//파라미터를 변수에 적용!!						//---------------------------------------------------------------------------------------------	----------------------					sql += "	SELECT	"		+	gdReq.getHeader("ITEM_ID"		).getValue(i) +		"	AS ITEM_ID,					\n";					sql += "				'"  + 	version								 		  + 	"' 	AS VERSION,					\n";					sql += " 						'1300'													AS PLANT_ID,				\n"; 					sql += " 						SYSDATE													AS MADE_DTTM,				\n";					sql += "				'"  + 	user_id								 		  + 		"' 	AS MADE_BY,				\n";					sql += " 				'"	+	gdReq.getHeader("MEINS"			).getValue(i) +		"'	AS PR_QTY_UOM,				\n"; 					sql += " 				'"	+	gdReq.getHeader("PR_QTY"		).getValue(i) +		"'	AS PR_QTY,					\n"; 					sql += " 	TO_CHAR(TO_DATE('"	+	gdReq.getHeader("IPGO_DATE"		).getValue(i) +	"'),'YYYYMMDD')	AS ENTR_DATE,	\n";					sql += " 						'I'														AS IF_FLAG,					\n"; 					sql += " 						'Y'														AS EDIT_FLAG				\n"; 					sql += "	FROM   DUAL																								\n";				} 				//-----------------------------Merge Into 1----------------------------------------------------------------------------------			sql += ") T2 														\n";			sql += "ON (T1.ITEM_ID    = T2.ITEM_ID    						   	\n";			sql += "AND T1.VERSION    = T2.VERSION         						\n";			sql += "AND T1.PLANT_ID   = T2.PLANT_ID )        					\n";			sql += "WHEN MATCHED THEN UPDATE SET            					\n";			sql += "     T1.MADE_BY      	= T2.MADE_BY,   					\n";			sql += "     T1.MADE_DTTM      	= T2.MADE_DTTM,   					\n";			sql += "     T1.PR_QTY_UOM      = T2.PR_QTY_UOM,   					\n";			sql += "     T1.PR_QTY      	= T2.PR_QTY,   					   	\n";			sql += "     T1.ENTR_DATE      	= T2.ENTR_DATE,   					\n";			sql += "     T1.IF_FLAG      	= T2.IF_FLAG,   					\n";			sql += "     T1.EDIT_FLAG      	= T2.EDIT_FLAG   					\n";			sql += "WHEN NOT MATCHED THEN                                       \n";			sql += "	INSERT                                                  \n";			sql += "	(                                                       \n";			sql += "	 T1.VERSION, T1.ITEM_ID, T1.PLANT_ID, T1.MADE_BY, T1.MADE_DTTM, T1.PR_QTY_UOM, T1.PR_QTY, T1.ENTR_DATE, T1.IF_FLAG, T1.EDIT_FLAG 	\n";			sql += "	) VALUES                                                                             												\n";			sql += "	(                                                                                    												\n";			sql += "	T2.VERSION, T2.ITEM_ID, T2.PLANT_ID, T2.MADE_BY, T2.MADE_DTTM, T2.PR_QTY_UOM, T2.PR_QTY, T2.ENTR_DATE, T2.IF_FLAG, T2.EDIT_FLAG  	\n";			sql += "	 )                                                                                    												\n";			 //---------------------------------------------------------------------------------------------------------------------------						System.out.println("-----------------------------------------------QUERY-----------------------------------------------");			System.out.println(sql);			System.out.println("-----------------------------------------------QUERY-----------------------------------------------");						System.out.println("executeQuery 실행!!!");						rs = databaseUtility.executeQuery(stmt, sql);						System.out.println("executeQuery 종료!!!");						/*			 * 화면에 전달할 파라미터를 설정한다. 메세지를 셋팅한다. Status를 설정한다			 */			gdRes.addParam("mode", "doIf");			gdRes.setMessage("성공적으로 작업하였습니다.");			gdRes.setStatus("true");					}catch (Exception e) {			throw e;		}finally {            databaseUtility.close(conn, stmt, rs);           }        System.out.println("doIf() end!!!");		return gdRes;	}		}                                                                                                                  